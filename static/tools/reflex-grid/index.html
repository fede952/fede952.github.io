<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>ReflexGrid - Aim Trainer & Reaction Test</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0e1a;--bg2:#0d1225;--bg3:#111833;
  --cyan:#00f0ff;--cyan-dim:#00b8c4;--cyan-glow:rgba(0,240,255,.2);
  --red:#ff2244;--red-glow:rgba(255,34,68,.3);
  --orange:#ff8800;--yellow:#ffcc00;--green:#00ff88;
  --text:#c8d0e0;--text2:#667;--text3:#445;
  --border:#1a2040;--border2:#253060;
  --mono:'SF Mono','Cascadia Code','Fira Code',Consolas,'Courier New',monospace;
  --sans:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--mono);overflow:hidden;-webkit-font-smoothing:antialiased;touch-action:manipulation;-webkit-tap-highlight-color:transparent}

.app{display:flex;flex-direction:column;height:100vh;max-width:100%;overflow:hidden}

/* Canvas Container */
.canvas-wrap{flex:1;position:relative;min-height:0;cursor:crosshair}
.canvas-wrap canvas{display:block;width:100%;height:100%}

/* Overlay Screens */
.overlay{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(10,14,26,.92);z-index:10;padding:20px;text-align:center;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
.overlay.hidden{display:none}

.overlay h1{font-size:clamp(28px,6vw,48px);color:var(--cyan);text-transform:uppercase;letter-spacing:6px;text-shadow:0 0 30px var(--cyan-glow),0 0 60px rgba(0,240,255,.1);margin-bottom:8px}
.overlay .sub{font-size:clamp(12px,2.5vw,16px);color:var(--text2);letter-spacing:2px;margin-bottom:32px}

.start-btn{padding:16px 48px;font-family:var(--mono);font-size:clamp(14px,3vw,18px);font-weight:700;text-transform:uppercase;letter-spacing:4px;color:var(--bg);background:var(--cyan);border:none;border-radius:6px;cursor:pointer;transition:all .2s;box-shadow:0 0 30px var(--cyan-glow)}
.start-btn:hover{transform:scale(1.05);box-shadow:0 0 50px var(--cyan-glow),0 0 80px rgba(0,240,255,.15)}
.start-btn:active{transform:scale(.97)}

/* Stats Screen */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:24px 0;width:min(400px,90vw)}
.stat-card{background:var(--bg3);border:1px solid var(--border2);border-radius:8px;padding:16px 12px;text-align:center}
.stat-card .val{font-size:clamp(24px,5vw,36px);font-weight:700;color:var(--cyan);text-shadow:0 0 15px var(--cyan-glow)}
.stat-card .lbl{font-size:11px;color:var(--text2);text-transform:uppercase;letter-spacing:1.5px;margin-top:4px}
.stat-card.full{grid-column:1 / -1}

.rank-badge{font-size:clamp(20px,4vw,32px);font-weight:900;text-transform:uppercase;letter-spacing:6px;padding:14px 32px;border-radius:8px;margin:8px 0 24px}
.rank-pro{color:#00ff88;border:2px solid #00ff88;background:rgba(0,255,136,.08);text-shadow:0 0 20px rgba(0,255,136,.4)}
.rank-gamer{color:var(--cyan);border:2px solid var(--cyan);background:rgba(0,240,255,.08);text-shadow:0 0 20px var(--cyan-glow)}
.rank-casual{color:var(--yellow);border:2px solid var(--yellow);background:rgba(255,204,0,.08);text-shadow:0 0 20px rgba(255,204,0,.3)}
.rank-novice{color:var(--orange);border:2px solid var(--orange);background:rgba(255,136,0,.08);text-shadow:0 0 20px rgba(255,136,0,.3)}
.rank-potato{color:var(--red);border:2px solid var(--red);background:rgba(255,34,68,.08);text-shadow:0 0 20px var(--red-glow)}

/* Ad Placeholder */
.ad-unit{min-height:90px;background:#080c16;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:center;color:var(--text3);font-size:11px;font-family:var(--mono);text-transform:uppercase;letter-spacing:2px;flex-shrink:0}

/* Responsive */
@media(max-width:640px){
  .stats-grid{grid-template-columns:1fr 1fr;gap:8px}
  .stat-card{padding:12px 8px}
  .overlay h1{letter-spacing:3px}
}
</style>
</head>
<body>
<div class="app">
  <div class="canvas-wrap" id="canvasWrap">
    <canvas id="gameCanvas"></canvas>

    <!-- Start Screen -->
    <div class="overlay" id="startScreen">
      <h1>Reflex<span style="color:#fff">Grid</span></h1>
      <div class="sub">Aim Trainer &amp; Reaction Test</div>
      <button class="start-btn" id="startBtn">Start Training</button>
    </div>

    <!-- Game Over Screen -->
    <div class="overlay hidden" id="endScreen">
      <h1 style="font-size:clamp(22px,5vw,36px);margin-bottom:4px">Training Complete</h1>
      <div class="rank-badge" id="rankBadge">-</div>
      <div class="stats-grid">
        <div class="stat-card"><div class="val" id="statHits">0</div><div class="lbl">Targets Hit</div></div>
        <div class="stat-card"><div class="val" id="statAcc">0%</div><div class="lbl">Accuracy</div></div>
        <div class="stat-card"><div class="val" id="statAvg">0ms</div><div class="lbl">Avg Reaction</div></div>
        <div class="stat-card"><div class="val" id="statTotal">0</div><div class="lbl">Total Clicks</div></div>
      </div>
      <button class="start-btn" id="restartBtn">Play Again</button>
    </div>
  </div>

  <div class="ad-unit">Advertisement</div>
</div>

<script>
/* ── Audio Engine (Web Audio API) ── */
const AudioCtx=window.AudioContext||window.webkitAudioContext;
let audioCtx;
function ensureAudio(){if(!audioCtx)audioCtx=new AudioCtx()}

function playHit(){
  ensureAudio();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);
  o.type='square';o.frequency.setValueAtTime(880,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(1760,audioCtx.currentTime+.06);
  g.gain.setValueAtTime(.15,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.12);
  o.start();o.stop(audioCtx.currentTime+.12);
}

function playMiss(){
  ensureAudio();
  const o=audioCtx.createOscillator();
  const g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);
  o.type='sawtooth';o.frequency.setValueAtTime(200,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(80,audioCtx.currentTime+.15);
  g.gain.setValueAtTime(.1,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(.001,audioCtx.currentTime+.2);
  o.start();o.stop(audioCtx.currentTime+.2);
}

/* ── Game State ── */
const canvas=document.getElementById('gameCanvas');
const ctx=canvas.getContext('2d');
const wrap=document.getElementById('canvasWrap');

let W,H,dpr;
let gameRunning=false;
let timeLeft=60;
let score=0;
let totalClicks=0;
let hits=0;
let reactionTimes=[];
let targetSpawnTime=0;
let animFrame;
let timerInterval;

/* Target */
let target={x:0,y:0,r:0,visible:false,color:'#00f0ff',pulsePhase:0};
const TARGET_R_MIN=20;
const TARGET_R_MAX=35;

/* Hit particles */
let particles=[];

/* Grid animation offset */
let gridOffset=0;

/* ── Canvas Resize ── */
function resize(){
  dpr=window.devicePixelRatio||1;
  const rect=wrap.getBoundingClientRect();
  W=rect.width;H=rect.height;
  canvas.width=W*dpr;canvas.height=H*dpr;
  canvas.style.width=W+'px';canvas.style.height=H+'px';
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize',resize);
resize();

/* ── Spawn Target ── */
function spawnTarget(){
  const r=TARGET_R_MIN+Math.random()*(TARGET_R_MAX-TARGET_R_MIN);
  const pad=r+20;
  const hudH=50;
  target.x=pad+Math.random()*(W-2*pad);
  target.y=hudH+pad+Math.random()*(H-hudH-2*pad);
  target.r=r;
  target.visible=true;
  target.pulsePhase=0;
  /* Alternate colors */
  target.color=Math.random()>.4?'#00f0ff':'#ff2244';
  targetSpawnTime=performance.now();
}

/* ── Particles ── */
function emitParticles(x,y,color){
  for(let i=0;i<12;i++){
    const angle=Math.random()*Math.PI*2;
    const speed=2+Math.random()*4;
    particles.push({x,y,vx:Math.cos(angle)*speed,vy:Math.sin(angle)*speed,life:1,color,r:2+Math.random()*3});
  }
}

/* ── Drawing ── */
function drawGrid(){
  ctx.strokeStyle='rgba(20,40,80,.4)';
  ctx.lineWidth=.5;
  const spacing=50;
  const ox=gridOffset%spacing;
  for(let x=ox;x<W;x+=spacing){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
  for(let y=ox;y<H;y+=spacing){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
  /* Accent lines */
  ctx.strokeStyle='rgba(0,240,255,.06)';
  ctx.lineWidth=1;
  const sp2=spacing*4;
  const ox2=gridOffset%sp2;
  for(let x=ox2;x<W;x+=sp2){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke()}
  for(let y=ox2;y<H;y+=sp2){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke()}
}

function drawHUD(){
  /* Top bar */
  ctx.fillStyle='rgba(10,14,26,.85)';
  ctx.fillRect(0,0,W,46);
  ctx.strokeStyle='rgba(0,240,255,.2)';
  ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(0,46);ctx.lineTo(W,46);ctx.stroke();

  ctx.font='bold 13px '+getComputedStyle(document.body).fontFamily;
  ctx.textBaseline='middle';

  /* Timer */
  ctx.fillStyle=timeLeft<=10?'#ff2244':'#00f0ff';
  ctx.textAlign='left';
  ctx.fillText('TIME  '+String(timeLeft).padStart(2,'0')+'s',14,23);

  /* Score */
  ctx.fillStyle='#00ff88';
  ctx.textAlign='center';
  ctx.fillText('HITS  '+hits,W/2,23);

  /* Accuracy */
  const acc=totalClicks>0?Math.round((hits/totalClicks)*100):100;
  ctx.fillStyle=acc>=80?'#00f0ff':acc>=50?'#ffcc00':'#ff2244';
  ctx.textAlign='right';
  ctx.fillText('ACC  '+acc+'%',W-14,23);
}

function drawTarget(){
  if(!target.visible)return;
  target.pulsePhase+=.08;
  const pulse=1+Math.sin(target.pulsePhase)*.12;
  const r=target.r*pulse;
  const isCyan=target.color==='#00f0ff';
  const glowColor=isCyan?'rgba(0,240,255,':'rgba(255,34,68,';

  /* Outer glow */
  const grad=ctx.createRadialGradient(target.x,target.y,r*.3,target.x,target.y,r*2.5);
  grad.addColorStop(0,glowColor+'.15)');
  grad.addColorStop(1,glowColor+'0)');
  ctx.fillStyle=grad;
  ctx.beginPath();ctx.arc(target.x,target.y,r*2.5,0,Math.PI*2);ctx.fill();

  /* Ring */
  ctx.strokeStyle=target.color;
  ctx.lineWidth=2;
  ctx.globalAlpha=.4;
  ctx.beginPath();ctx.arc(target.x,target.y,r*1.5,0,Math.PI*2);ctx.stroke();
  ctx.globalAlpha=1;

  /* Main circle */
  const cg=ctx.createRadialGradient(target.x,target.y,0,target.x,target.y,r);
  cg.addColorStop(0,'#ffffff');
  cg.addColorStop(.3,target.color);
  cg.addColorStop(1,isCyan?'#0088aa':'#aa1133');
  ctx.fillStyle=cg;
  ctx.beginPath();ctx.arc(target.x,target.y,r,0,Math.PI*2);ctx.fill();

  /* Inner dot */
  ctx.fillStyle='rgba(255,255,255,.9)';
  ctx.beginPath();ctx.arc(target.x,target.y,r*.2,0,Math.PI*2);ctx.fill();

  /* Crosshair lines */
  ctx.strokeStyle=glowColor+'.3)';
  ctx.lineWidth=1;
  const ch=r*1.8;
  ctx.beginPath();ctx.moveTo(target.x-ch,target.y);ctx.lineTo(target.x-r*1.2,target.y);ctx.stroke();
  ctx.beginPath();ctx.moveTo(target.x+r*1.2,target.y);ctx.lineTo(target.x+ch,target.y);ctx.stroke();
  ctx.beginPath();ctx.moveTo(target.x,target.y-ch);ctx.lineTo(target.x,target.y-r*1.2);ctx.stroke();
  ctx.beginPath();ctx.moveTo(target.x,target.y+r*1.2);ctx.lineTo(target.x,target.y+ch);ctx.stroke();
}

function drawParticles(){
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx;p.y+=p.vy;
    p.vx*=.96;p.vy*=.96;
    p.life-=.03;
    if(p.life<=0){particles.splice(i,1);continue}
    ctx.globalAlpha=p.life;
    ctx.fillStyle=p.color;
    ctx.beginPath();ctx.arc(p.x,p.y,p.r*p.life,0,Math.PI*2);ctx.fill();
  }
  ctx.globalAlpha=1;
}

/* ── Game Loop ── */
function gameLoop(){
  if(!gameRunning)return;
  ctx.clearRect(0,0,W,H);
  gridOffset+=.15;
  drawGrid();
  drawTarget();
  drawParticles();
  drawHUD();
  animFrame=requestAnimationFrame(gameLoop);
}

/* ── Input Handling ── */
function handleInput(cx,cy){
  if(!gameRunning||!target.visible)return;
  totalClicks++;
  const dx=cx-target.x;
  const dy=cy-target.y;
  const dist=Math.sqrt(dx*dx+dy*dy);

  if(dist<=target.r*1.3){
    /* HIT */
    hits++;
    const rt=performance.now()-targetSpawnTime;
    reactionTimes.push(rt);
    emitParticles(target.x,target.y,target.color);
    playHit();
    spawnTarget();
  }else{
    /* MISS */
    playMiss();
    emitParticles(cx,cy,'#ff2244');
  }
}

function getCanvasCoords(e){
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX||e.touches[0].clientX)-rect.left;
  const y=(e.clientY||e.touches[0].clientY)-rect.top;
  return{x,y};
}

canvas.addEventListener('mousedown',e=>{
  const c=getCanvasCoords(e);
  handleInput(c.x,c.y);
});
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  const c=getCanvasCoords(e);
  handleInput(c.x,c.y);
},{passive:false});

/* ── Timer ── */
function startTimer(){
  timeLeft=60;
  timerInterval=setInterval(()=>{
    timeLeft--;
    if(timeLeft<=0){
      timeLeft=0;
      endGame();
    }
  },1000);
}

/* ── Start / End ── */
function startGame(){
  ensureAudio();
  score=0;hits=0;totalClicks=0;reactionTimes=[];particles=[];
  target.visible=false;
  document.getElementById('startScreen').classList.add('hidden');
  document.getElementById('endScreen').classList.add('hidden');
  gameRunning=true;
  resize();
  spawnTarget();
  startTimer();
  gameLoop();
}

function endGame(){
  gameRunning=false;
  clearInterval(timerInterval);
  cancelAnimationFrame(animFrame);
  target.visible=false;

  const acc=totalClicks>0?Math.round((hits/totalClicks)*100):0;
  const avgRT=reactionTimes.length>0?Math.round(reactionTimes.reduce((a,b)=>a+b,0)/reactionTimes.length):0;

  document.getElementById('statHits').textContent=hits;
  document.getElementById('statAcc').textContent=acc+'%';
  document.getElementById('statAvg').textContent=avgRT+'ms';
  document.getElementById('statTotal').textContent=totalClicks;

  /* Rank */
  const badge=document.getElementById('rankBadge');
  badge.className='rank-badge';
  let rank,cls;
  if(reactionTimes.length===0){rank='No Data';cls='rank-potato'}
  else if(avgRT<200){rank='Pro';cls='rank-pro'}
  else if(avgRT<300){rank='Gamer';cls='rank-gamer'}
  else if(avgRT<400){rank='Casual';cls='rank-casual'}
  else if(avgRT<500){rank='Novice';cls='rank-novice'}
  else{rank='Potato';cls='rank-potato'}
  badge.textContent=rank;
  badge.classList.add(cls);

  document.getElementById('endScreen').classList.remove('hidden');
}

document.getElementById('startBtn').addEventListener('click',startGame);
document.getElementById('restartBtn').addEventListener('click',startGame);

/* ── Initial Draw ── */
function drawIdle(){
  ctx.clearRect(0,0,W,H);
  gridOffset+=.08;
  drawGrid();
  requestAnimationFrame(drawIdle);
}
/* Run idle background animation behind start screen */
(function idleLoop(){
  if(gameRunning)return;
  ctx.clearRect(0,0,W,H);
  gridOffset+=.08;
  drawGrid();
  requestAnimationFrame(idleLoop);
})();
</script>
<script>
/* AUTO-RESIZE SENDER */
(function(){
  function sendHeight(){
    var h=document.body.scrollHeight;
    window.parent.postMessage({type:"setHeight",height:h},"*");
  }
  document.documentElement.style.height="auto";
  document.body.style.height="auto";
  document.body.style.minHeight="0";
  window.addEventListener("load",sendHeight);
  window.addEventListener("resize",sendHeight);
  new MutationObserver(sendHeight).observe(document.body,{subtree:true,childList:true});
})();
</script>
</body>
</html>
